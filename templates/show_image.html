{% extends 'base.html' %}

{% block script %}
    <script type="text/javascript" src="{{ url_for('static', filename='js/polyline.js') }}"></script>
{% endblock %}

{% block app %}
    <div class="app-container">
        <div style="width: 100vw; overflow: auto;">
            <div style="position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                <img id="original" class="box" style="position: absolute; z-index: 1; margin-bottom: unset;"
                     src="/uploads/{{ uploaded_image }}"
                     alt="Original image">
                <canvas id="canvas" style="position: relative; z-index: 4;"></canvas>
            </div>
        </div>
        <div class="control" style="margin-bottom: 2rem;">
            <button class="button is-rounded is-link" type="submit" id="process">Process</button>
        </div>
        <div class="buttons field has-addons are-small">
            <div class="control">
                <button class="button is-light" type="button" id="measure">
                    Measuring tool
                </button>
            </div>
            <div id="show" class="dropdown">
                <div class="dropdown-trigger">
                    <button class="button is-light is-link" aria-haspopup="true" aria-controls="dropdown-menu">
                    <span>
                        Show…
                    </span>
                        <span class="icon is-small">
                    <i class="fas fa-angle-down" aria-hidden="true"></i>
                </span>
                    </button>
                </div>
                <div class="dropdown-menu" role="menu">
                    <div class="dropdown-content">
                        <a class="dropdown-item" id="showOriginalImage">
                            Original image
                        </a>
                        <a class="dropdown-item disabled" id="showProcessedImageColorPerObject">
                            Processed image (color per object)
                        </a>
                        <a class="dropdown-item disabled" id="showProcessedImageColorPerType">
                            Processed image (color per type)
                        </a>
                    </div>
                </div>
            </div>
            <div id="download" class="dropdown">
                <div class="dropdown-trigger">
                    <button class="button is-light" aria-haspopup="true" aria-controls="dropdown-menu">
                    <span>
                        Download…
                    </span>
                        <span class="icon is-small">
                    <i class="fas fa-angle-down" aria-hidden="true"></i>
                </span>
                    </button>
                </div>
                <div class="dropdown-menu" role="menu">
                    <div class="dropdown-content">
                        <a class="dropdown-item" id="downloadOriginalImage">
                            Original image
                        </a>
                        <a class="dropdown-item disabled" id="downloadProcessedImageColorPerObject">
                            Processed image (color per object)
                        </a>
                        <a class="dropdown-item disabled" id="downloadProcessedImageColorPerType">
                            Processed image (color per type)
                        </a>
                        <a class="dropdown-item disabled" id="downloadFoundObjects">
                            Found objects
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const processButton = document.getElementById("process");
        const measureButton = document.getElementById("measure");
        const originalImage = document.getElementById("original");
        const showDiv = document.getElementById("show");
        const showOriginalImage = document.getElementById("showOriginalImage");
        const showProcessedImageColorPerObject = document.getElementById("showProcessedImageColorPerObject");
        const showProcessedImageColorPerType = document.getElementById("showProcessedImageColorPerType");

        const downloadDiv = document.getElementById("download");
        const downloadOriginalImage = document.getElementById("downloadOriginalImage");
        const downloadProcessedImageColorPerObject = document.getElementById("downloadProcessedImageColorPerObject");
        const downloadProcessedImageColorPerType = document.getElementById("downloadProcessedImageColorPerType");
        const downloadFoundObjects = document.getElementById("downloadFoundObjects");

        const url = new URL(window.location.href);
        const imageFilename = url.searchParams.get("image");
        const dictionaryFilename = url.searchParams.get("dictionary");

        canvas = document.getElementById("canvas");
        ctx = canvas.getContext("2d");

        const dropdownElements = [showDiv, downloadDiv];
        document.addEventListener("click", event => {
            dropdownElements.filter(element => !element.contains(event.target))
                .forEach(element => element.classList.remove("is-active"));
            dropdownElements.filter(element => element.contains(event.target))
                .forEach(element => element.classList.toggle("is-active"));
        });

        let dataOriginal;

        function initImage() {
            dataOriginal = originalImage.src;

            downloadOriginalImage.href = dataOriginal;
            downloadOriginalImage.download = `${imageFilename}_original.png`;

            setupCanvas(originalImage);
            enableResizing();

            measureButton.disabled = false;
            measureButton.addEventListener("click", function () {
                resetPolyline();
                startPolyline();
            });

            originalImage.removeEventListener("load", initImage);
        }

        originalImage.addEventListener("load", initImage);
        originalImage.src = originalImage.src;

        processButton.addEventListener("click", function () {
            processButton.classList.add("is-loading");

            const requestData = JSON.stringify({"image": imageFilename, "dictionary": dictionaryFilename});

            const xhr = new XMLHttpRequest();
            xhr.open("POST", "/process_files", true);
            xhr.setRequestHeader("Content-Type", "application/json");

            xhr.onreadystatechange = function () {
                if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                    const data = JSON.parse(this.responseText);

                    const dataColorPerObject = "data:image/png;charset=utf-8;base64, " + data["color_per_object"];
                    const dataColorPerType = "data:image/png;charset=utf-8;base64, " + data["color_per_type"];
                    const dataFoundObjects = "data:text/json;charset=utf-8, " + encodeURI(data["networkx_json_graph_list"]);

                    downloadProcessedImageColorPerObject.href = dataColorPerObject;
                    downloadProcessedImageColorPerObject.download = `${imageFilename}_color_per_object.png`;
                    downloadProcessedImageColorPerType.href = dataColorPerType;
                    downloadProcessedImageColorPerType.download = `${imageFilename}_color_per_type.png`;
                    downloadFoundObjects.href = dataFoundObjects;
                    downloadFoundObjects.download = `${imageFilename}_networkx_json_graph_list.json`;

                    downloadProcessedImageColorPerObject.classList.remove("disabled");
                    downloadProcessedImageColorPerType.classList.remove("disabled");
                    downloadFoundObjects.classList.remove("disabled");

                    processButton.classList.remove("is-loading");

                    originalImage.src = dataColorPerObject;

                    showProcessedImageColorPerObject.classList.remove("disabled");
                    showProcessedImageColorPerType.classList.remove("disabled");
                    showOriginalImage.onclick = () => originalImage.src = dataOriginal;
                    showProcessedImageColorPerObject.onclick = () => originalImage.src = dataColorPerObject;
                    showProcessedImageColorPerType.onclick = () => originalImage.src = dataColorPerType;
                }
            };

            xhr.send(requestData);
        });
    </script>
{% endblock %}
